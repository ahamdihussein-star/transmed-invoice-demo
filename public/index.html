<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmed Invoice Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-cyan-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìÑ Transmed Invoice Upload</h1>
            <p class="text-blue-200">Session: <span id="session-id" class="font-mono"></span></p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
            <div id="step1-indicator" class="w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium">1</div>
            <div id="line1" class="w-12 h-0.5 bg-cyan-500"></div>
            <div id="step2-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">2</div>
            <div id="line2" class="w-12 h-0.5 bg-white/10"></div>
            <div id="step3-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">3</div>
        </div>

        <!-- Step 1: Upload Invoice -->
        <div id="step1" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">üì§ Upload Invoice(s)</h2>
                <p class="text-blue-200">Upload your invoice PDF - supports multiple invoices in one file</p>
            </div>

            <div class="mb-6">
                <input type="file" id="invoice-input" accept=".pdf,image/*" class="hidden">
                <label for="invoice-input" id="invoice-box" class="block w-full p-8 border-2 border-dashed border-white/30 hover:border-cyan-400 rounded-xl text-center cursor-pointer transition-all">
                    <span class="text-5xl block mb-2">üìÑ</span>
                    <span class="text-white/60">Tap to upload invoice PDF or image</span>
                </label>
            </div>

            <div id="ocr-status" class="text-center py-4 hidden">
                <span class="spinner mr-2"></span>
                <span class="text-cyan-400">Extracting data from invoice(s)...</span>
            </div>

            <div id="extracted-box" class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 hidden">
                <p class="text-emerald-400 font-medium mb-3">‚úì Invoices Extracted:</p>
                <div id="invoice-count" class="text-white/80 text-sm mb-2"></div>
                <div id="extracted-text" class="text-white/80 text-sm space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <button id="step1-btn" onclick="goToStep(2)" disabled class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl disabled:opacity-50 transition-all mt-6">
                Continue ‚Üí
            </button>
        </div>

        <!-- Step 2: Review All Invoices -->
        <div id="step2" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">‚úèÔ∏è Review All Invoices</h2>
                <p class="text-blue-200">Verify extracted information for all invoices</p>
            </div>

            <div id="invoices-container" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                <!-- Invoices will be rendered here -->
            </div>

            <div class="flex gap-3">
                <button onclick="goToStep(1)" class="flex-1 py-4 bg-white/10 text-white font-semibold rounded-xl">‚Üê Back</button>
                <button onclick="submitData()" class="flex-1 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl">Submit All</button>
            </div>
        </div>

        <!-- Step 3: Success -->
        <div id="step3" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Upload Complete!</h2>
            <p class="text-blue-200 mb-2"><span id="success-count"></span> invoice(s) uploaded successfully.</p>
            <p class="text-white/60 text-sm">Return to chat and type <span class="font-mono bg-white/10 px-2 py-1 rounded">"done"</span></p>
        </div>
    </div>

    <script>
        const OCR_KEY = 'K85947283488957';
        const API_BASE = window.location.origin;
        
        let sessionId = 'DEMO';
        let file = null;
        let invoices = []; // Array to store multiple invoices

        function init() {
            sessionId = 'DEMO';
            history.pushState({}, '', `/upload/${sessionId}`);
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('invoice-input').onchange = handleFile;
        }

        function handleFile(e) {
            file = e.target.files[0];
            if (!file) return;
            
            const box = document.getElementById('invoice-box');
            box.innerHTML = `<span class="text-cyan-400">‚úì ${file.name}</span>`;
            box.classList.add('border-cyan-500', 'bg-cyan-500/10');
            
            runOCR(file);
            document.getElementById('step1-btn').disabled = false;
        }

        async function runOCR(file) {
            document.getElementById('ocr-status').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('apikey', OCR_KEY);
            formData.append('language', 'eng');
            formData.append('OCREngine', '2');

            try {
                const res = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.ParsedResults?.[0]) {
                    extractMultipleInvoices(json.ParsedResults[0].ParsedText);
                }
            } catch (err) {
                console.error('OCR error:', err);
            }
            
            document.getElementById('ocr-status').classList.add('hidden');
        }

        function extractMultipleInvoices(text) {
            // Split text into individual invoices based on "Number" keyword followed by long number
            const lines = text.split('\n');
            let invoiceSections = [];
            let currentSection = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Detect start of new invoice: "Number" followed by 10+ digit number
                if (/^Number$/i.test(line) && lines[i+1]?.match(/^\d{10,15}$/)) {
                    // Save previous section if exists
                    if (currentSection.length > 0) {
                        invoiceSections.push(currentSection.join('\n'));
                    }
                    // Start new section
                    currentSection = [line];
                } else {
                    currentSection.push(line);
                }
            }
            
            // Add last section
            if (currentSection.length > 0) {
                invoiceSections.push(currentSection.join('\n'));
            }
            
            // If no clear sections found, treat entire text as one invoice
            if (invoiceSections.length === 0) {
                invoiceSections = [text];
            }
            
            // Extract data from each invoice section
            invoices = invoiceSections.map(section => extractSingleInvoice(section));
            
            // Filter out invalid invoices (no invoice number found)
            invoices = invoices.filter(inv => inv.invoice && inv.invoice.length >= 10);
            
            showExtracted();
            renderInvoicesForReview();
        }

        function extractSingleInvoice(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            let invoice = { invoice: '', supplier: '', amount: '', currency: '', date: '' };
            
            // Extract invoice number
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (/(?:number|invoice)/i.test(line)) {
                    const numberMatch = line.match(/\b\d{10,15}\b/) || 
                                       lines[i+1]?.match(/\b\d{10,15}\b/);
                    if (numberMatch) {
                        invoice.invoice = numberMatch[0];
                        break;
                    }
                }
            }
            if (!invoice.invoice) {
                invoice.invoice = text.match(/\b\d{10,15}\b/)?.[0] || '';
            }
            
            // Extract supplier
            let supplier = text.match(/([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,4}\s+(?:AB|EMEA|LLC|LTD|LIMITED|INC|S\.A\.|GMBH|PLC|CORP))/i)?.[1];
            if (!supplier) {
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    const match = lines[i].match(/^([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){1,3})$/);
                    if (match && match[1].length > 5) {
                        supplier = match[1];
                        break;
                    }
                }
            }
            invoice.supplier = supplier?.trim() || '';
            
            // Extract amount
            let amount = null;
            for (let i = 0; i < lines.length; i++) {
                if (/(?:invoice\s+amount|total)/i.test(lines[i])) {
                    const amountMatch = lines[i].match(/([0-9]{1,3}(?:[,\s]\d{3})*[,\.]\d{2})/) ||
                                       lines[i+1]?.match(/([0-9]{1,3}(?:[,\s]\d{3})*[,\.]\d{2})/);
                    if (amountMatch) {
                        amount = amountMatch[1];
                        break;
                    }
                }
            }
            if (!amount) {
                amount = text.match(/\b([0-9]{1,3}(?:[,\s]\d{3})+[,\.]\d{2})\b/)?.[1];
            }
            if (amount) {
                invoice.amount = amount.replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
            }
            
            // Extract currency
            const currency = text.match(/\b(EUR|USD|GBP|AED|SAR)\b/i)?.[1];
            invoice.currency = currency?.toUpperCase() || '';
            
            // Extract invoice date (not due date)
            let dateMatch = null;
            for (let i = 0; i < lines.length; i++) {
                if (/^Invoice\s+date$/i.test(lines[i])) {
                    dateMatch = lines[i+1]?.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/);
                    if (dateMatch) break;
                } else if (/Invoice\s+date[:\s]/i.test(lines[i])) {
                    dateMatch = lines[i].match(/Invoice\s+date[:\s]+(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i);
                    if (dateMatch) {
                        dateMatch = [dateMatch[0], dateMatch[1]];
                        break;
                    }
                }
            }
            
            if (dateMatch) {
                const dateStr = dateMatch[1];
                const parts = dateStr.split(/[\/\-\.]/);
                if (parts.length === 3 && parts[2].length === 4) {
                    const first = parseInt(parts[0]);
                    const second = parseInt(parts[1]);
                    let day, month, year = parts[2];
                    
                    if (first > 12) {
                        day = parts[0].padStart(2, '0');
                        month = parts[1].padStart(2, '0');
                    } else if (second > 12) {
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                    } else {
                        // Default DD/MM/YYYY
                        day = parts[0].padStart(2, '0');
                        month = parts[1].padStart(2, '0');
                    }
                    
                    invoice.date = `${year}-${month}-${day}`;
                }
            }
            
            return invoice;
        }

        function showExtracted() {
            const box = document.getElementById('extracted-box');
            const countEl = document.getElementById('invoice-count');
            const txt = document.getElementById('extracted-text');
            
            if (invoices.length > 0) {
                countEl.textContent = `Found ${invoices.length} invoice(s)`;
                let html = '';
                invoices.forEach((inv, idx) => {
                    html += `<div class="p-2 bg-white/5 rounded">
                        <strong>Invoice ${idx + 1}:</strong> ${inv.invoice} - ${inv.supplier} - ${inv.amount} ${inv.currency}
                    </div>`;
                });
                txt.innerHTML = html;
                box.classList.remove('hidden');
            }
        }

        function renderInvoicesForReview() {
            const container = document.getElementById('invoices-container');
            container.innerHTML = '';
            
            invoices.forEach((inv, idx) => {
                const div = document.createElement('div');
                div.className = 'bg-white/5 rounded-xl p-4 border border-white/10';
                div.innerHTML = `
                    <h3 class="text-white font-semibold mb-3">Invoice #${idx + 1}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-white/60 mb-1">Invoice Number</label>
                            <input type="text" value="${inv.invoice}" data-idx="${idx}" data-field="invoice"
                                   class="invoice-field w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-white/60 mb-1">Supplier</label>
                            <input type="text" value="${inv.supplier}" data-idx="${idx}" data-field="supplier"
                                   class="invoice-field w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-white/60 mb-1">Amount</label>
                            <input type="text" value="${inv.amount}" data-idx="${idx}" data-field="amount"
                                   class="invoice-field w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-white/60 mb-1">Currency</label>
                            <input type="text" value="${inv.currency}" data-idx="${idx}" data-field="currency"
                                   class="invoice-field w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-white/60 mb-1">Invoice Date</label>
                            <input type="date" value="${inv.date}" data-idx="${idx}" data-field="date"
                                   class="invoice-field w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white text-sm">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Add event listeners for field changes
            document.querySelectorAll('.invoice-field').forEach(field => {
                field.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const fieldName = e.target.dataset.field;
                    invoices[idx][fieldName] = e.target.value;
                });
            });
        }

        function goToStep(n) {
            ['step1','step2','step3'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('step' + n).classList.remove('hidden');
            
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('step' + i + '-indicator');
                dot.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ' + 
                    (i <= n ? 'bg-cyan-500 text-white' : 'bg-white/10 text-white/50');
                dot.textContent = i < n ? '‚úì' : i;
            }
            document.getElementById('line1').className = 'w-12 h-0.5 ' + (n > 1 ? 'bg-cyan-500' : 'bg-white/10');
            document.getElementById('line2').className = 'w-12 h-0.5 ' + (n > 2 ? 'bg-cyan-500' : 'bg-white/10');
        }

        async function submitData() {
            const submittedData = {
                invoices: invoices.map(inv => ({
                    invoice: inv.invoice,
                    supplier: inv.supplier,
                    amount: inv.amount,
                    currency: inv.currency,
                    date: inv.date
                })),
                status: 'submitted',
                submittedAt: new Date().toISOString(),
                count: invoices.length
            };

            try {
                const res = await fetch(`${API_BASE}/api/invoice/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: submittedData })
                });
                
                if (res.ok) {
                    document.getElementById('success-count').textContent = invoices.length;
                    goToStep(3);
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting data. Please try again.');
            }
        }

        init();
    </script>
</body>
</html>
