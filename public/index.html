<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmed Invoice Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-cyan-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìÑ Transmed Invoice Upload</h1>
            <p class="text-blue-200">Powered by Nanonets AI ‚Ä¢ Session: <span id="session-id" class="font-mono"></span></p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
            <div id="step1-indicator" class="w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium">1</div>
            <div id="line1" class="w-12 h-0.5 bg-cyan-500"></div>
            <div id="step2-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">2</div>
            <div id="line2" class="w-12 h-0.5 bg-white/10"></div>
            <div id="step3-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">3</div>
        </div>

        <!-- Step 1: Upload Invoice -->
        <div id="step1" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">üì§ Upload Invoice(s)</h2>
                <p class="text-blue-200">Upload your invoice PDF - Nanonets AI will extract all data automatically</p>
            </div>

            <div class="mb-6">
                <input type="file" id="invoice-input" accept=".pdf,image/*" class="hidden">
                <label for="invoice-input" id="invoice-box" class="block w-full p-8 border-2 border-dashed border-white/30 hover:border-cyan-400 rounded-xl text-center cursor-pointer transition-all">
                    <span class="text-5xl block mb-2">üìÑ</span>
                    <span class="text-white/60">Tap to upload invoice PDF or image</span>
                </label>
            </div>

            <div id="ocr-status" class="text-center py-4 hidden">
                <span class="spinner mr-2"></span>
                <span class="text-cyan-400">Processing with Nanonets AI OCR...</span>
                <p class="text-white/60 text-xs mt-2">This may take 10-30 seconds</p>
            </div>

            <div id="error-box" class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 hidden">
                <p class="text-red-400 font-medium mb-2">‚ùå Error:</p>
                <p id="error-message" class="text-white/80 text-sm"></p>
            </div>

            <div id="extracted-box" class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 hidden">
                <p class="text-emerald-400 font-medium mb-3">‚úì Invoices Extracted with Nanonets:</p>
                <div id="invoice-count" class="text-white/80 text-sm mb-2"></div>
                <div id="extracted-summary" class="text-white/80 text-sm space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <button id="step1-btn" onclick="goToStep(2)" disabled class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl disabled:opacity-50 transition-all mt-6">
                Continue to Review ‚Üí
            </button>
        </div>

        <!-- Step 2: Review All Invoices -->
        <div id="step2" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">‚úèÔ∏è Review All Invoices</h2>
                <p class="text-blue-200">Verify and edit extracted information</p>
            </div>

            <div id="invoices-container" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                <!-- Invoices will be rendered here -->
            </div>

            <div class="flex gap-3">
                <button onclick="goToStep(1)" class="flex-1 py-4 bg-white/10 text-white font-semibold rounded-xl">‚Üê Back</button>
                <button onclick="submitData()" class="flex-1 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl">Submit All Invoices</button>
            </div>
        </div>

        <!-- Step 3: Success -->
        <div id="step3" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Upload Complete!</h2>
            <p class="text-blue-200 mb-2"><span id="success-count"></span> invoice(s) processed successfully.</p>
            <p class="text-white/60 text-sm mb-4">Data has been extracted and is ready for booking.</p>
            <div class="bg-white/5 rounded-lg p-4 text-left">
                <p class="text-white/80 text-sm">üìù <strong>Next Steps:</strong></p>
                <ol class="text-white/60 text-sm mt-2 space-y-1 list-decimal list-inside">
                    <li>Return to Boomi Agent chat</li>
                    <li>Type <span class="font-mono bg-white/10 px-2 py-1 rounded">"done"</span></li>
                    <li>Agent will retrieve and process the invoices</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        let sessionId = 'DEMO';
        let file = null;
        let invoices = [];

        function init() {
            const pathParts = window.location.pathname.split('/');
            sessionId = pathParts[pathParts.length - 1] || 'DEMO';
            
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('invoice-input').onchange = handleFile;
        }

        function handleFile(e) {
            file = e.target.files[0];
            if (!file) return;
            
            const box = document.getElementById('invoice-box');
            box.innerHTML = `<span class="text-cyan-400">‚úì ${file.name}</span>`;
            box.classList.add('border-cyan-500', 'bg-cyan-500/10');
            
            uploadAndExtract(file);
        }

        async function uploadAndExtract(file) {
            // Hide any previous messages
            document.getElementById('error-box').classList.add('hidden');
            document.getElementById('extracted-box').classList.add('hidden');
            document.getElementById('step1-btn').disabled = true;
            
            // Show loading
            document.getElementById('ocr-status').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('sessionId', sessionId);

            try {
                console.log('üì§ Uploading to backend...');
                
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('üì• Backend response:', result);

                if (response.ok && result.success) {
                    invoices = result.invoices || [];
                    
                    console.log(`‚úÖ Extracted ${invoices.length} invoice(s)`);
                    
                    // Show simple summary - Agent will show details later
                    showExtractedSummary();
                    
                    document.getElementById('step1-btn').disabled = false;
                } else {
                    showError(result.message || result.error || 'Failed to extract invoice data');
                }

            } catch (error) {
                console.error('‚ùå Upload error:', error);
                showError(`Network error: ${error.message}`);
            } finally {
                document.getElementById('ocr-status').classList.add('hidden');
            }
        }

        function showError(message) {
            const errorBox = document.getElementById('error-box');
            const errorMsg = document.getElementById('error-message');
            
            errorMsg.textContent = message;
            errorBox.classList.remove('hidden');
            
            // Reset upload box
            const box = document.getElementById('invoice-box');
            box.innerHTML = `<span class="text-5xl block mb-2">üìÑ</span>
                            <span class="text-white/60">Tap to upload invoice PDF or image</span>`;
            box.classList.remove('border-cyan-500', 'bg-cyan-500/10');
        }

        function showExtractedSummary() {
            const box = document.getElementById('extracted-box');
            const countEl = document.getElementById('invoice-count');
            const summaryEl = document.getElementById('extracted-summary');
            
            if (invoices.length > 0) {
                countEl.textContent = `‚úì Processing complete`;
                
                // Simple message with count only - no details
                let html = `
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-green-500/20 rounded-full mb-4">
                            <span class="text-5xl">‚úì</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2">
                            ${invoices.length} Invoice${invoices.length > 1 ? 's' : ''} Extracted
                        </h3>
                        <p class="text-white/80 mb-4">
                            All invoice data has been successfully extracted using OCR
                        </p>
                        <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 max-w-md mx-auto">
                            <p class="text-cyan-400 font-medium mb-2">
                                ü§ñ Next Step
                            </p>
                            <p class="text-white/70 text-sm">
                                Return to the Boomi Agent chat and type <span class="font-mono bg-white/10 px-2 py-0.5 rounded">"done"</span> to process the invoices
                            </p>
                        </div>
                    </div>
                `;
                
                summaryEl.innerHTML = html;
                box.classList.remove('hidden');
            }
        }

        function renderInvoicesForReview() {
            const container = document.getElementById('invoices-container');
            container.innerHTML = '';
            
            invoices.forEach((inv, idx) => {
                const div = document.createElement('div');
                div.className = 'bg-white/5 rounded-xl p-5 border border-white/10';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-white font-semibold text-lg">Invoice #${idx + 1}</h3>
                        <span class="px-3 py-1 bg-cyan-500/20 text-cyan-400 text-sm rounded-full">
                            Supplier #${inv.supplier_number || '999999'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs text-white/60 mb-1.5">Invoice Number</label>
                            <input type="text" value="${inv.invoice_number || ''}" data-idx="${idx}" data-field="invoice_number"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-xs text-white/60 mb-1.5">Supplier Name</label>
                            <input type="text" value="${inv.supplier_name || ''}" data-idx="${idx}" data-field="supplier_name"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">Delivered From</label>
                            <input type="text" value="${inv.delivered_from || ''}" data-idx="${idx}" data-field="delivered_from"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">Country of Origin</label>
                            <input type="text" value="${inv.country_oo || ''}" data-idx="${idx}" data-field="country_oo"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">Total Payable</label>
                            <input type="text" value="${inv.total_payable || ''}" data-idx="${idx}" data-field="total_payable"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">Currency</label>
                            <select data-idx="${idx}" data-field="currency"
                                    class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                                <option value="USD" ${inv.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="EUR" ${inv.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="AED" ${inv.currency === 'AED' ? 'selected' : ''}>AED</option>
                                <option value="SAR" ${inv.currency === 'SAR' ? 'selected' : ''}>SAR</option>
                                <option value="GBP" ${inv.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">VAT Amount</label>
                            <input type="text" value="${inv.vat || '0'}" data-idx="${idx}" data-field="vat"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs text-white/60 mb-1.5">Invoice Date</label>
                            <input type="text" value="${inv.invoice_date || ''}" data-idx="${idx}" data-field="invoice_date"
                                   placeholder="YYYY-MM-DD"
                                   class="invoice-field w-full px-3 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:border-cyan-500 focus:outline-none">
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-white/5 rounded-lg">
                        <p class="text-xs text-white/60 mb-2">Calculated Fields:</p>
                        <div class="grid grid-cols-3 gap-3 text-xs">
                            <div>
                                <span class="text-white/60">Tax Rate Area:</span>
                                <span class="text-white ml-1">${inv.tax_rate_area || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-white/60">Tax Ex:</span>
                                <span class="text-white ml-1">${inv.tax_ex || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-white/60">GL Date:</span>
                                <span class="text-white ml-1">${inv.gl_date || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Add event listeners for field updates
            document.querySelectorAll('.invoice-field').forEach(field => {
                field.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    const fieldName = e.target.dataset.field;
                    invoices[idx][fieldName] = e.target.value;
                    console.log(`Updated invoice ${idx} field ${fieldName}:`, e.target.value);
                });
            });
        }

        function goToStep(n) {
            // Hide all steps
            ['step1','step2','step3'].forEach(s => document.getElementById(s).classList.add('hidden'));
            
            // Show current step
            document.getElementById('step' + n).classList.remove('hidden');
            
            // Update indicators
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('step' + i + '-indicator');
                if (i < n) {
                    dot.className = 'w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium';
                    dot.textContent = '‚úì';
                } else if (i === n) {
                    dot.className = 'w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium';
                    dot.textContent = i;
                } else {
                    dot.className = 'w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium';
                    dot.textContent = i;
                }
            }
            
            // Update lines
            document.getElementById('line1').className = 'w-12 h-0.5 ' + (n > 1 ? 'bg-cyan-500' : 'bg-white/10');
            document.getElementById('line2').className = 'w-12 h-0.5 ' + (n > 2 ? 'bg-cyan-500' : 'bg-white/10');
        }

        async function submitData() {
            console.log('üì¶ Submitting invoices to backend...');
            
            const submittedData = {
                invoices: invoices,
                status: 'submitted',
                submittedAt: new Date().toISOString(),
                count: invoices.length
            };

            try {
                // Note: We don't need PUT because /api/upload already stored the data
                // But we can call it to update with any user edits
                const res = await fetch(`${API_BASE}/api/invoice/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: submittedData })
                });
                
                if (res.ok) {
                    console.log('‚úÖ Data submitted successfully');
                    document.getElementById('success-count').textContent = invoices.length;
                    goToStep(3);
                } else {
                    const error = await res.json();
                    throw new Error(error.message || 'Submission failed');
                }
            } catch (err) {
                console.error('‚ùå Submit error:', err);
                alert(`Error submitting data: ${err.message}\n\nPlease try again.`);
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
