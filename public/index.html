<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmed Invoice Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-cyan-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìÑ Transmed Invoice Upload</h1>
            <p class="text-blue-200">Session: <span id="session-id" class="font-mono"></span></p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
            <div id="step1-indicator" class="w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium">1</div>
            <div id="line1" class="w-12 h-0.5 bg-cyan-500"></div>
            <div id="step2-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">2</div>
            <div id="line2" class="w-12 h-0.5 bg-white/10"></div>
            <div id="step3-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">3</div>
        </div>

        <!-- Step 1: Upload Invoice -->
        <div id="step1" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">üì§ Upload Invoice</h2>
                <p class="text-blue-200">Upload your invoice PDF</p>
            </div>

            <div class="mb-6">
                <input type="file" id="invoice-input" accept=".pdf,image/*" class="hidden">
                <label for="invoice-input" id="invoice-box" class="block w-full p-8 border-2 border-dashed border-white/30 hover:border-cyan-400 rounded-xl text-center cursor-pointer transition-all">
                    <span class="text-5xl block mb-2">üìÑ</span>
                    <span class="text-white/60">Tap to upload invoice PDF or image</span>
                </label>
            </div>

            <div id="ocr-status" class="text-center py-4 hidden">
                <span class="spinner mr-2"></span>
                <span class="text-cyan-400">Extracting data from invoice...</span>
            </div>

            <div id="extracted-box" class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 hidden">
                <p class="text-emerald-400 font-medium mb-2">‚úì Data Extracted:</p>
                <div id="extracted-text" class="text-white/80 text-sm space-y-1"></div>
            </div>

            <button id="step1-btn" onclick="goToStep(2)" disabled class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl disabled:opacity-50 transition-all mt-6">
                Continue ‚Üí
            </button>
        </div>

        <!-- Step 2: Review Data -->
        <div id="step2" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">‚úèÔ∏è Review & Confirm</h2>
                <p class="text-blue-200">Verify extracted information</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Invoice Number</label>
                    <input type="text" id="f-invoice" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="Enter invoice number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Supplier Name</label>
                    <input type="text" id="f-supplier" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="Enter supplier">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Amount</label>
                        <input type="text" id="f-amount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Currency</label>
                        <input type="text" id="f-currency" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="EUR">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Invoice Date</label>
                    <input type="date" id="f-date" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="goToStep(1)" class="flex-1 py-4 bg-white/10 text-white font-semibold rounded-xl">‚Üê Back</button>
                <button onclick="submitData()" class="flex-1 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl">Submit</button>
            </div>
        </div>

        <!-- Step 3: Success -->
        <div id="step3" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Upload Complete!</h2>
            <p class="text-blue-200 mb-6">Your invoice has been uploaded successfully.</p>
            <p class="text-white/60 text-sm">Return to chat and type <span class="font-mono bg-white/10 px-2 py-1 rounded">"done"</span></p>
        </div>
    </div>

    <script>
        const OCR_KEY = 'K85947283488957';
        const API_BASE = window.location.origin;
        
        let sessionId = 'DEMO';
        let file = null;
        let data = { invoice: '', supplier: '', amount: '', currency: '', date: '' };

        function init() {
            sessionId = 'DEMO';
            history.pushState({}, '', `/upload/${sessionId}`);
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-input').onchange = handleFile;
        }

        function handleFile(e) {
            file = e.target.files[0];
            if (!file) return;
            
            const box = document.getElementById('invoice-box');
            box.innerHTML = `<span class="text-cyan-400">‚úì ${file.name}</span>`;
            box.classList.add('border-cyan-500', 'bg-cyan-500/10');
            
            runOCR(file);
            document.getElementById('step1-btn').disabled = false;
        }

        async function runOCR(file) {
            document.getElementById('ocr-status').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('apikey', OCR_KEY);
            formData.append('language', 'eng');
            formData.append('OCREngine', '2');

            try {
                const res = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.ParsedResults?.[0]) {
                    extractData(json.ParsedResults[0].ParsedText);
                }
            } catch (err) {
                console.error('OCR error:', err);
            }
            
            document.getElementById('ocr-status').classList.add('hidden');
        }

        function extractData(text) {
            // Clean and normalize text
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            // Extract invoice number - look for long numbers near "invoice" or "number" keywords
            let invoice = null;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                // Look for patterns like "Number 3010600056969" or "Invoice: 12345"
                if (/(?:number|invoice|inv|#)/i.test(line)) {
                    const numberMatch = line.match(/\b\d{10,15}\b/) || 
                                       lines[i+1]?.match(/\b\d{10,15}\b/);
                    if (numberMatch) {
                        invoice = numberMatch[0];
                        break;
                    }
                }
            }
            // Fallback: find any 10-15 digit number in the document
            if (!invoice) {
                invoice = text.match(/\b\d{10,15}\b/)?.[0];
            }
            if (invoice) data.invoice = invoice;

            // Extract supplier - look for company names with proper capitalization
            let supplier = null;
            // Pattern 1: Company name with legal suffix (AB, LLC, LTD, INC, S.A., GMBH, etc.)
            supplier = text.match(/([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,4}\s+(?:AB|EMEA|LLC|LTD|LIMITED|INC|INCORPORATED|S\.A\.|GMBH|PLC|CORP))/i)?.[1];
            
            // Pattern 2: Look in first 10 lines for capitalized company names
            if (!supplier) {
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    const line = lines[i];
                    // Look for 2-4 capitalized words (typical company name)
                    const match = line.match(/^([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){1,3})$/);
                    if (match && match[1].length > 5) {
                        supplier = match[1];
                        break;
                    }
                }
            }
            if (supplier) data.supplier = supplier.trim();

            // Extract amount - look for currency amounts near "total" or "amount" keywords
            let amount = null;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (/(?:invoice\s+amount|total|amount|subtotal)/i.test(line)) {
                    // Look for numbers with decimal point and 2 decimal places
                    const amountMatch = line.match(/([0-9]{1,3}(?:[,\s]\d{3})*[,\.]\d{2})/) ||
                                       lines[i+1]?.match(/([0-9]{1,3}(?:[,\s]\d{3})*[,\.]\d{2})/);
                    if (amountMatch) {
                        amount = amountMatch[1];
                        break;
                    }
                }
            }
            // Fallback: find any large number with 2 decimals (likely an amount)
            if (!amount) {
                amount = text.match(/\b([0-9]{1,3}(?:[,\s]\d{3})+[,\.]\d{2})\b/)?.[1] ||
                        text.match(/\b([0-9]{4,}[,\.]\d{2})\b/)?.[1];
            }
            if (amount) {
                // Clean up: remove spaces, convert European format (1.234,56) to US format (1234.56)
                data.amount = amount.replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
                // If it still has multiple dots, keep only last one
                const parts = data.amount.split('.');
                if (parts.length > 2) {
                    data.amount = parts.slice(0, -1).join('') + '.' + parts[parts.length - 1];
                }
            }

            // Extract currency - look for standard currency codes
            const currency = text.match(/\b(EUR|USD|GBP|AED|SAR|JPY|CHF|CAD|AUD|CNY|INR)\b/i)?.[1];
            if (currency) data.currency = currency.toUpperCase();
            
            // Extract date - multiple date format patterns
            let dateMatch = null;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (/(?:invoice\s+date|date|issued)/i.test(line)) {
                    dateMatch = line.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/) ||
                               lines[i+1]?.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/);
                    if (dateMatch) break;
                }
            }
            // Fallback: find any date in document
            if (!dateMatch) {
                dateMatch = text.match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})/);
            }
            
            if (dateMatch) {
                // Parse date from various formats
                const dateStr = dateMatch[1];
                const separator = dateStr.includes('/') ? '/' : dateStr.includes('-') ? '-' : '.';
                const parts = dateStr.split(separator);
                
                if (parts.length === 3) {
                    let day, month, year;
                    
                    // Detect year position (usually 4 digits)
                    const yearIndex = parts.findIndex(p => p.length === 4);
                    
                    if (yearIndex === 2) {
                        // Format: DD/MM/YYYY or MM/DD/YYYY
                        const first = parseInt(parts[0]);
                        const second = parseInt(parts[1]);
                        
                        if (first > 12) {
                            // Must be DD/MM/YYYY
                            day = parts[0].padStart(2, '0');
                            month = parts[1].padStart(2, '0');
                        } else if (second > 12) {
                            // Must be MM/DD/YYYY
                            month = parts[0].padStart(2, '0');
                            day = parts[1].padStart(2, '0');
                        } else {
                            // Ambiguous - try both, prefer DD/MM/YYYY (international standard)
                            // But check context: if month name appears nearby, use that
                            const contextMonth = text.match(/\b(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i);
                            if (contextMonth) {
                                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                                const shortMonths = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                                const monthNum = monthNames.findIndex(m => m.toLowerCase() === contextMonth[1].toLowerCase()) + 1 ||
                                               shortMonths.findIndex(m => m.toLowerCase() === contextMonth[1].toLowerCase()) + 1;
                                if (monthNum > 0) {
                                    month = monthNum.toString().padStart(2, '0');
                                    day = (first === monthNum ? second : first).toString().padStart(2, '0');
                                }
                            } else {
                                // Default: assume DD/MM/YYYY (ISO standard outside US)
                                day = parts[0].padStart(2, '0');
                                month = parts[1].padStart(2, '0');
                            }
                        }
                        year = parts[2];
                    } else if (yearIndex === 0) {
                        // Format: YYYY/MM/DD
                        year = parts[0];
                        month = parts[1].padStart(2, '0');
                        day = parts[2].padStart(2, '0');
                    }
                    
                    if (year && month && day) {
                        data.date = `${year}-${month}-${day}`;
                    }
                }
            }

            showExtracted();
            fillForm();
        }

        function showExtracted() {
            const box = document.getElementById('extracted-box');
            const txt = document.getElementById('extracted-text');
            let html = '';
            if (data.invoice) html += `<p><strong>Invoice:</strong> ${data.invoice}</p>`;
            if (data.supplier) html += `<p><strong>Supplier:</strong> ${data.supplier}</p>`;
            if (data.amount) html += `<p><strong>Amount:</strong> ${data.amount} ${data.currency || ''}</p>`;
            if (html) {
                txt.innerHTML = html;
                box.classList.remove('hidden');
            }
        }

        function fillForm() {
            if (data.invoice) document.getElementById('f-invoice').value = data.invoice;
            if (data.supplier) document.getElementById('f-supplier').value = data.supplier;
            if (data.amount) document.getElementById('f-amount').value = data.amount;
            if (data.currency) document.getElementById('f-currency').value = data.currency;
            if (data.date) document.getElementById('f-date').value = data.date;
        }

        function goToStep(n) {
            ['step1','step2','step3'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('step' + n).classList.remove('hidden');
            
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('step' + i + '-indicator');
                dot.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ' + 
                    (i <= n ? 'bg-cyan-500 text-white' : 'bg-white/10 text-white/50');
                dot.textContent = i < n ? '‚úì' : i;
            }
            document.getElementById('line1').className = 'w-12 h-0.5 ' + (n > 1 ? 'bg-cyan-500' : 'bg-white/10');
            document.getElementById('line2').className = 'w-12 h-0.5 ' + (n > 2 ? 'bg-cyan-500' : 'bg-white/10');
        }

        async function submitData() {
            const submittedData = {
                invoice: document.getElementById('f-invoice').value,
                supplier: document.getElementById('f-supplier').value,
                amount: document.getElementById('f-amount').value,
                currency: document.getElementById('f-currency').value,
                date: document.getElementById('f-date').value,
                status: 'submitted',
                submittedAt: new Date().toISOString()
            };

            try {
                const res = await fetch(`${API_BASE}/api/invoice/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: submittedData })
                });
                
                if (res.ok) {
                    goToStep(3);
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting data. Please try again.');
            }
        }

        init();
    </script>
</body>
</html>
