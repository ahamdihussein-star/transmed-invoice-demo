<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmed Invoice Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-cyan-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìÑ Transmed Invoice Upload</h1>
            <p class="text-blue-200">Session: <span id="session-id" class="font-mono"></span></p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
            <div id="step1-indicator" class="w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center text-sm font-medium">1</div>
            <div id="line1" class="w-12 h-0.5 bg-cyan-500"></div>
            <div id="step2-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">2</div>
            <div id="line2" class="w-12 h-0.5 bg-white/10"></div>
            <div id="step3-indicator" class="w-8 h-8 rounded-full bg-white/10 text-white/50 flex items-center justify-center text-sm font-medium">3</div>
        </div>

        <!-- Step 1: Upload Invoice -->
        <div id="step1" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">üì§ Upload Invoice</h2>
                <p class="text-blue-200">Upload your invoice PDF</p>
            </div>

            <div class="mb-6">
                <input type="file" id="invoice-input" accept=".pdf,image/*" class="hidden">
                <label for="invoice-input" id="invoice-box" class="block w-full p-8 border-2 border-dashed border-white/30 hover:border-cyan-400 rounded-xl text-center cursor-pointer transition-all">
                    <span class="text-5xl block mb-2">üìÑ</span>
                    <span class="text-white/60">Tap to upload invoice PDF or image</span>
                </label>
            </div>

            <div id="ocr-status" class="text-center py-4 hidden">
                <span class="spinner mr-2"></span>
                <span class="text-cyan-400">Extracting data from invoice...</span>
            </div>

            <div id="extracted-box" class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 hidden">
                <p class="text-emerald-400 font-medium mb-2">‚úì Data Extracted:</p>
                <div id="extracted-text" class="text-white/80 text-sm space-y-1"></div>
            </div>

            <button id="step1-btn" onclick="goToStep(2)" disabled class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl disabled:opacity-50 transition-all mt-6">
                Continue ‚Üí
            </button>
        </div>

        <!-- Step 2: Review Data -->
        <div id="step2" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">‚úèÔ∏è Review & Confirm</h2>
                <p class="text-blue-200">Verify extracted information</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Invoice Number</label>
                    <input type="text" id="f-invoice" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="Enter invoice number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Supplier Name</label>
                    <input type="text" id="f-supplier" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="Enter supplier">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Amount</label>
                        <input type="text" id="f-amount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/80 mb-1">Currency</label>
                        <input type="text" id="f-currency" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40" placeholder="EUR">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-white/80 mb-1">Invoice Date</label>
                    <input type="date" id="f-date" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="goToStep(1)" class="flex-1 py-4 bg-white/10 text-white font-semibold rounded-xl">‚Üê Back</button>
                <button onclick="submitData()" class="flex-1 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold rounded-xl">Submit</button>
            </div>
        </div>

        <!-- Step 3: Success -->
        <div id="step3" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-2xl animate-fadeIn hidden text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-white mb-4">Upload Complete!</h2>
            <p class="text-blue-200 mb-6">Your invoice has been uploaded successfully.</p>
            <p class="text-white/60 text-sm">Return to chat and type <span class="font-mono bg-white/10 px-2 py-1 rounded">"done"</span></p>
        </div>
    </div>

    <script>
        const OCR_KEY = 'K85947283488957';
        const API_BASE = window.location.origin;
        
        let sessionId = 'DEMO';
        let file = null;
        let data = { invoice: '', supplier: '', amount: '', currency: '', date: '' };

        function init() {
            sessionId = 'DEMO';
            history.pushState({}, '', `/upload/${sessionId}`);
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-input').onchange = handleFile;
        }

        function handleFile(e) {
            file = e.target.files[0];
            if (!file) return;
            
            const box = document.getElementById('invoice-box');
            box.innerHTML = `<span class="text-cyan-400">‚úì ${file.name}</span>`;
            box.classList.add('border-cyan-500', 'bg-cyan-500/10');
            
            runOCR(file);
            document.getElementById('step1-btn').disabled = false;
        }

        async function runOCR(file) {
            document.getElementById('ocr-status').classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('apikey', OCR_KEY);
            formData.append('language', 'eng');
            formData.append('OCREngine', '2');

            try {
                const res = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.ParsedResults?.[0]) {
                    extractData(json.ParsedResults[0].ParsedText);
                }
            } catch (err) {
                console.error('OCR error:', err);
            }
            
            document.getElementById('ocr-status').classList.add('hidden');
        }

        function extractData(text) {
            // Extract invoice number
            const invoice = text.match(/(?:INVOICE|INV|#)[:\s#]*([A-Z0-9\-]+)/i)?.[1] || 
                           text.match(/\b\d{10,}\b/)?.[0];
            if (invoice) data.invoice = invoice;

            // Extract supplier (look for company names)
            const supplier = text.match(/([A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+)*\s+(?:AB|EMEA|LLC|LTD|INC|GMBH))/)?.[1] ||
                           text.match(/^([A-Z][A-Za-z\s&]+)$/m)?.[1];
            if (supplier) data.supplier = supplier.trim();

            // Extract amount
            const amount = text.match(/(?:TOTAL|AMOUNT|SUBTOTAL)[:\s]*([0-9,\.]+)/i)?.[1] ||
                         text.match(/([0-9]{1,3}(?:[,\.]\d{3})*[,\.]\d{2})/)?.[1];
            if (amount) data.amount = amount.replace(/,/g, '');

            // Extract currency
            const currency = text.match(/\b(EUR|USD|GBP|AED|SAR)\b/)?.[1];
            if (currency) data.currency = currency;

            showExtracted();
            fillForm();
        }

        function showExtracted() {
            const box = document.getElementById('extracted-box');
            const txt = document.getElementById('extracted-text');
            let html = '';
            if (data.invoice) html += `<p><strong>Invoice:</strong> ${data.invoice}</p>`;
            if (data.supplier) html += `<p><strong>Supplier:</strong> ${data.supplier}</p>`;
            if (data.amount) html += `<p><strong>Amount:</strong> ${data.amount} ${data.currency || ''}</p>`;
            if (html) {
                txt.innerHTML = html;
                box.classList.remove('hidden');
            }
        }

        function fillForm() {
            if (data.invoice) document.getElementById('f-invoice').value = data.invoice;
            if (data.supplier) document.getElementById('f-supplier').value = data.supplier;
            if (data.amount) document.getElementById('f-amount').value = data.amount;
            if (data.currency) document.getElementById('f-currency').value = data.currency;
        }

        function goToStep(n) {
            ['step1','step2','step3'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('step' + n).classList.remove('hidden');
            
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('step' + i + '-indicator');
                dot.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ' + 
                    (i <= n ? 'bg-cyan-500 text-white' : 'bg-white/10 text-white/50');
                dot.textContent = i < n ? '‚úì' : i;
            }
            document.getElementById('line1').className = 'w-12 h-0.5 ' + (n > 1 ? 'bg-cyan-500' : 'bg-white/10');
            document.getElementById('line2').className = 'w-12 h-0.5 ' + (n > 2 ? 'bg-cyan-500' : 'bg-white/10');
        }

        async function submitData() {
            const submittedData = {
                invoice: document.getElementById('f-invoice').value,
                supplier: document.getElementById('f-supplier').value,
                amount: document.getElementById('f-amount').value,
                currency: document.getElementById('f-currency').value,
                date: document.getElementById('f-date').value,
                status: 'submitted',
                submittedAt: new Date().toISOString()
            };

            try {
                const res = await fetch(`${API_BASE}/api/invoice/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: submittedData })
                });
                
                if (res.ok) {
                    goToStep(3);
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting data. Please try again.');
            }
        }

        init();
    </script>
</body>
</html>
